# --- Builder
FROM rust:1-bookworm AS builder
WORKDIR /app

# Build binary
COPY Cargo.toml Cargo.lock ./
COPY api/Cargo.toml api/Cargo.toml
COPY ingestor/Cargo.toml ingestor/Cargo.toml
COPY . .
RUN cargo build -p api --release --locked

# --- Runtime (distroless)
FROM gcr.io/distroless/cc-debian12:nonroot AS runtime
WORKDIR /app
COPY --from=builder /app/target/release/api /app/api
USER nonroot:nonroot
ENTRYPOINT ["/app/api"]
CMD ["--help"]
